<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>物品費 2025</title>
    <script>
        function getJsonFilesInFolder(folder) {
            return new Promise((resolve, reject) => {
                console.log(`Getting JSON files in folder: ${folder}`);
                
                // This is a temporary solution. For a more flexible approach, consider using a server-side script to dynamically retrieve the list of JSON files.
                const jsonFilesByFolder = {
                    '実験実習費': ['20250414141658.json'],
                    '分担金：24H00024': [],
                    '若手研究：24K16957': []
                };
                
                const jsonFiles = jsonFilesByFolder[folder] || [];
                console.log(`JSON files in ${folder}: ${jsonFiles.join(', ')}`);
                
                resolve(jsonFiles);
            });
        }

        function loadExpenseData(folder) {
            return new Promise((resolve, reject) => {
                console.log(`Loading data from folder: ${folder}`);
                
                // Get the list of JSON files for this folder
                getJsonFilesInFolder(folder).then(jsonFiles => {
                    console.log(`JSON files for ${folder}: ${jsonFiles.join(', ')}`);
                    
                    // Process each JSON file
                    let processedFiles = 0;
                    if (jsonFiles.length === 0) {
                        resolve(); // No files to process
                        return;
                    }
                    
                    jsonFiles.forEach(jsonFile => {
                        const fileXhr = new XMLHttpRequest();
                        fileXhr.open('GET', `${folder}/json/${jsonFile}`, true);
                        fileXhr.onload = function() {
                            if (fileXhr.status === 200) {
                                try {
                                    const data = JSON.parse(fileXhr.responseText);
                                    console.log(`Loaded data from ${jsonFile}:`, data);
                                    updateTable(data, folder);
                                    processedFiles++;
                                    if (processedFiles === jsonFiles.length) {
                                        resolve();
                                    }
                                } catch (error) {
                                    console.error(`Error parsing JSON from ${jsonFile}:`, error);
                                    reject(error);
                                }
                            } else {
                                console.error(`Error loading ${jsonFile}: ${fileXhr.status}`);
                                reject(new Error(`HTTP error! status: ${fileXhr.status}`));
                            }
                        };
                        fileXhr.onerror = function() {
                            console.error(`Network error loading ${jsonFile}`);
                            reject(new Error('Network error'));
                        };
                        fileXhr.send();
                    });
                }).catch(error => {
                    console.error(`Error getting JSON files for ${folder}:`, error);
                    reject(error);
                });
            });
        }

        function getJsonFilesForFolder(folder) {
            // Define the list of JSON files for each folder
            // This is a temporary solution. For a more flexible approach, consider using a server-side script to dynamically retrieve the list of JSON files.
            const jsonFilesByFolder = {
                '実験実習費': ['20250414141658.json'],
                '分担金：24H00024': [],
                '若手研究：24K16957': []
            };
            
            return jsonFilesByFolder[folder] || [];
        }

        function updateTable(data, folder) {
            const tbody = document.querySelector(`#expenseTable_${folder.replace(/[：]/g, '_')} tbody`);
            const date = new Date(data.payment_date);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date.getMonth() + 1}</td>
                <td>${date.getDate()}</td>
                <td>物品費</td>
                <td>${data.items[0].product_name}</td>
                <td>${data.items[0].provider}</td>
                <td>${data.items[0].model}</td>
                <td><a href="${folder}/pdf/${data.pdf_file}">${data.title}</a></td>
                <td></td>
                <td>${data.items[0].total_price.toLocaleString()}円</td>
                <td></td>
            `;
            tbody.appendChild(row);
        }

        window.onload = function() {
            const folders = ['実験実習費', '分担金：24H00024', '若手研究：24K16957'];
            folders.forEach(folder => {
                // Check if folder exists
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', `${folder}/json/`, true);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        loadExpenseData(folder).catch(error => {
                            console.error(`Error loading expense data from ${folder}:`, error);
                            // Display error in the table
                            const tbody = document.querySelector(`#expenseTable_${folder.replace(/[：]/g, '_')} tbody`);
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="8" style="color: red;">エラー: ${error.message}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        console.log(`Folder ${folder} does not exist, skipping...`);
                    }
                };
                xhr.onerror = function() {
                    console.log(`Folder ${folder} does not exist, skipping...`);
                };
                xhr.send();
            });
        };
    </script>
</head>
<body>
<h1>物品費 2025</h1>

<h2>実験実習費</h2>
<table border=1 id="expenseTable_実験実習費">
<thead>
    <tr>
        <td>月</td>
        <td>日</td>
        <td>経費種目</td>
        <td>品目</td>
        <td>発行元</td>
        <td>品番</td>
        <td>領収書等</td>
        <td>事務処理関連書類</td>
        <td>金額</td>
        <td>その他</td>
    </tr>
</thead>
<tbody>
</tbody>
</table>

<h2>分担金：24H00024</h2>
<table border=1 id="expenseTable_分担金_24H00024">
<thead>
    <tr>
        <td>月</td>
        <td>日</td>
        <td>経費種目</td>
        <td>品目</td>
        <td>発行元</td>
        <td>品番</td>
        <td>領収書等</td>
        <td>事務処理関連書類</td>
        <td>金額</td>
        <td>その他</td>
    </tr>
</thead>
<tbody>
</tbody>
</table>

<h2>若手研究：24K16957</h2>
<table border=1 id="expenseTable_若手研究_24K16957">
<thead>
    <tr>
        <td>月</td>
        <td>日</td>
        <td>経費種目</td>
        <td>品目</td>
        <td>発行元</td>
        <td>品番</td>
        <td>領収書等</td>
        <td>事務処理関連書類</td>
        <td>金額</td>
        <td>その他</td>
    </tr>
</thead>
<tbody>
</tbody>
</table>

</body>
</html>
